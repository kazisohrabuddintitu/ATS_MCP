stages:
  - test
  - lint
  - build
  - deploy

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip/
    - venv/

before_script:
  - python -m venv venv
  - source venv/bin/activate
  - pip install --upgrade pip
  - pip install -r requirements.txt

test:
  stage: test
  script:
    - source venv/bin/activate
    - pip install pytest
    - python -m pytest tests/ -v || echo "No tests found - skipping test stage"
  only:
    - main
    - merge_requests

lint:
  stage: lint
  script:
    - source venv/bin/activate
    - pip install flake8 black
    - flake8 --max-line-length=88 --extend-ignore=E203,W503 *.py
    - black --check *.py
  only:
    - main
    - merge_requests
  allow_failure: true

build:
  stage: build
  script:
    - source venv/bin/activate
    - echo "Testing API server startup..."
    - timeout 10s uvicorn api_server:app --host 127.0.0.1 --port 8000 || true
    - echo "Testing MCP server import..."
    - python -c "import mcp_server; print('MCP server imports successfully')"
    - python -c "import api_server; print('API server imports successfully')"
    - python -c "import graph_functions; print('Graph functions import successfully')"
  only:
    - main
    - merge_requests

deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H "$SERVER_HOST" >> ~/.ssh/known_hosts
  script:
    - echo "Connecting to server and updating application..."
    - |
      ssh "$SSH_USER@$SERVER_HOST" << 'EOF'
        cd $PROJECT_PATH
        git pull origin main
        docker-compose down
        docker-compose build --no-cache
        docker-compose up -d
        echo "Deployment completed successfully"
      EOF
  environment:
    name: production
    url: $PRODUCTION_URL
  only:
    - main
  when: manual